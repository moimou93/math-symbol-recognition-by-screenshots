# 文档

## 创意来源

> 天下苦符号久矣！

在大一下学期学习离散（1）的过程中，我常常会为数学符号的编辑而苦恼（包括但不限于$$\and 、\or、\oplus、\vdash、\to $$）

而我在搜索引擎中搜到的有关公式编辑相关语法的网站，虽然都配备有完备的对照搜索的文档，但只有一部分配备有图片识别的功能；而这一部分配备有图片识别功能的网站，几乎全都是有使用次数限制的，想要继续使用就必须充值/分享等。

由此，我计划设计一个**截图数学符号识别**的工具，从而有效提高数学编辑相关工作的效率

## 运行环境

* `Python3.12`
* `Torch2.4.0`
* `Matplotlib3.8.4`
* `PyQt5.15.10`

> 只保证在以上环境下可以完成运行。

## 实现思路与技术细节

1. 数学符号识别：Pytorch
2. 截图功能：PyQt5
3. 以上两者的整合
4. UI界面设计：PyQt5

### 符号识别

#### 数据加载

1. **`idxPrepare(path)`**:
   - 使用 `ImageFolder` 读取图片文件夹
   - 存储 类别->索引 和 索引->类别 的字典，使得label能够转化成tensor类型
   - 得到由（图片路径，类别索引）元组构成的列表
2. **`image2txt(path_idx, r=1)`**:
   - 将图片路径和类别索引写入 `train.txt` 和 `test.txt` 文件，用于训练和测试数据集。
   - 使用随机数决定图片的分配到训练集还是测试集，在这里`r=1`，代表90%训练，10%索引
3. **`MyLoader(path)`**:
   - 加载指定路径的图片
4. **`MyData(Dataset)`**:
   - 自定义数据集类，继承`Dataset`类，读取 `txt` 文件中的图片路径和标签。
   - 实现了数据加载和转换功能，包括图片加载和标签转换。
5. **`LoadDataset(data_path, batch_size, img_size)`**:
   - 调用 `idxPrepare` 和 `image2txt` 函数准备数据。
   - 根据是否指定 `img_size` 来设置图片的尺寸，并返回训练和测试数据的 DataLoader 对象。
   - 本模块的主函数

在数据加载模块中，最终将不同类型、不同尺寸的图片和标签统一变成了可以用于训练的tensor类型，并分出了训练集和测试集

#### 模型

1. 定义模型：

   在这一部分定义了`leNet`、`alexNet`、`vgg11`、`NiN`、`GoogLeNet`、`resNet18`、`denseNet`五种模型

2. `select_model(model_name=str, kwargs=dict)`：

   * 根据用户提供的模型名称选择并加载相应的模型
   * 根据选择的模型的不同，传入不同的字典，将图片调整至不通的尺寸

#### 训练过程可视化

本部分就是从`history`字典中提取训练和测试的损失和准确率列表，再设置一下图表的属性（坐标轴标签，标题），将其绘制成图，保存为`.jpg`文件

#### 训练

1. `accuracy(y_hat,y)`：

   * 检查`y_hat`是否为多类分类的输出，若是，则取每行最大值作为预测类别
   * 比较预测结果`y_hat`和实际标签`y`是否相等，得到一个布尔类型向量
   * 布尔类型转化为浮点类型，求和，返回预测正确的样本数

2. `train(model_in_use,model_kargs,train_iter,test_iter,num_epochs,lr,`

   `device,threshold,save_checkpoint=False)`:

   * 选择模型并使用`init_weights`函数初始化权重
   * 指定误差函数和优化器
   * 在每个训练周期（epoch）中，遍历训练数据，计算损失和准确率，更新权重，并利用`tqdm`库显示训练进度。
   * 在每个训练周期结束后，评估模型在测试数据上的表现。
   * 如果准确率达到95%以上，训练提前停止，保存模型权重

3. `main`：

   * 定义一系列参数：批次大小，输入通道数，预测类别数，训练轮次，学习率，提前停止的阈值，数据路径，使用的模型，模型参数，设备
   * 调用`LoadDatast`函数加载训练集和测试集
   * 调用`train`函数进行训练
   * 调用`plot_history`将训练过程可视化

#### 预测

1. **`imageTransform(img, img_size)`**:
   - 对图像进行预处理，包括调整大小和转换为灰度图。
   - 将图像转换为浮点型并展开，以适配模型输入要求。
2. **`getIdxDict()`**:
   - 从 `idx2class` 文件加载类别索引字典，映射预测索引到类别名称。
3. **`predictByImage(net, path, img_size)`**:
   - 读取并预处理图像，然后通过模型进行预测。
   - 返回处理后的图像和预测结果的类别索引。
4. **`judge(path)`**:
   - 确定模型参数和图像尺寸，根据所选模型（`GoogLeNet`、`leNet`、`alexNet`、`vgg11`）设置不同的图像尺寸。
   - 从 `idx2class` 文件获取类别字典，选择模型并进行预测。
   - 路径在将来为截得的图片保存的路径。如果路径为空，则输出提示信息；否则，进行预测并打印结果。

> 本部分是符号识别的核心功能，也是需要和截图功能整合到一起的部分

### 截图功能

#### 主窗口MyWin

1. 初始化（`__init__`和`initUI`方法）：
   * 设置窗口的标题、大小、位置
   * 创建一个`btn`按钮，点击按钮或者使用快捷键“Alt+z”调用用`click_btn`方法，开始截图
2. `click_btn`：
   * 将主窗口最小化（防止遮挡要截图的区域）
   * 创建并显示截图窗口`ScrrenShotsWin`

#### 截图窗口ScrrenShotsWin

1. 初始化（`__init__`和`initUI`方法）：
   * 设置截图窗口的透明度为0.2，使得能告诉用户进入截图界面的同时不至于影响原屏幕显示内容
   * 连接`oksignal`信号到`screenshots`方法上，用于截图操作
2. `screenshots`：
   * 根据用户选择的区域，截取屏幕上的图片。
   * 使用 `QApplication.primaryScreen().grabWindow()` 来抓取屏幕区域。
   * 显示保存文件对话框，保存截图到指定路径。
   * 调用 `judge` 函数来处理截图，得到预测结果，并将结果显示在 `ResultWin` 窗口。
   * 关闭当前截图窗口。
3. 事件处理 (`paintEvent`,`mousePressEvent`, `mouseReleaseEvent`, `mouseMoveEvent` 方法)：
   - `mousePressEvent` 记录开始坐标。
   - `mouseReleaseEvent` 记录结束坐标并触发截图操作。
   - `mouseMoveEvent` 更新选区的实时显示。
   - `paintEvent`绘制出选中区域的边框

### 功能整合

设计思路：截得图片->得到其保存路径->传入`predict`函数中对其进行预测->将预测结果用可视化界面显示出来

1. 创建一个`MyWin`类，运行时再点击‘截图’按钮，即可创建截图类，进入截图界面，此时再选择要截图的区域即可截得图片
1. 在`screenshots`方法中，选择保存地址之后，就将该地址传入全局变量`img_path`中
1. 然后将`img_path`传入`predict`函数中，即可完成预测
1. 最后通过创建一个`ResulWin`类，将预测结果可视化展示出来

### UI界面设计

由于本项目本义是为了打造一个实用性工具，所以UI界面设计以简洁为主

其中`MyWin`主窗口中只包含一个`截图`按钮，可以选择点击按钮开始截图，也可以选择使用快捷键`Alt+Z`开始截图

在最终结果显示窗口`ResultWin`中，设置了一个label用于存放最终结果，还设置了两个按钮

1. `将结果复制到剪贴板上`：点击此按钮后即可将窗口上的文本复制到剪贴板上
2. `转化为Latex格式`：将数学符号转化为Latex格式，更便于数学符号编辑



## 总结

1. 学会使用Anaconda来管理Python环境
2. 掌握PyTorch的基本使用方法，对于深度学习领域相关知识有了一些基本的认识
3. 学会了使用PyQt5构造简单的用户界面
4. 首次独立实现一个对于目前的自己来说比较大的项目，工程代码能力有了一定提升
5. 但是由于目前的水平有限，目前的符号识别的准确率在手写体、印刷体等不同情况下还不是很理想，并且只能处理简单的单个符号，无法识别复杂的、有多层嵌套关系的数学公式，在将来希望能够继续完善此项目
6. 既然已经做了数学符号识别，将来能不能做公式识别？能不能直接计算一些数学公式？或者说能不能做英语单词识别？这是我认为本项目最有趣的点所在：其扩展性非常强，我希望未来能够将其打造成我个人会经常使用的一个工具集。就拿英语单词识别举例，如果我再接入几大翻译软件的端口，包括英译汉和英译英的，相信对于未来阅读英语文献材料和精进英语学习方面也是能极大地提高效率的。

## 数据集下载地址

https://bhpan.buaa.edu.cn/link/AA54F4731181F7425FA53939D2453F3658
文件名：extracted_images.zip
有效期限：2024-09-27 17:02
提取码：ueJI
